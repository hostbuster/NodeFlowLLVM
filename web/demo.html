<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>NodeFlow Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#f8fafc; margin-bottom:12px; }
    .brand { font-weight:800; letter-spacing:0.5px; }
    .actions { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .actions button { padding:6px 10px; border:1px solid #d1d5db; background:#ffffff; border-radius:6px; cursor:pointer; }
    .actions button:hover { background:#f1f5f9; }
    .actions select, .actions input { padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; background:#fff; }
    .status { margin-left:8px; color:#334155; font-weight:600; }
    h2 { margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 360px 200px; gap: 16px; align-items: center; margin: 8px 0; }
    .ctrl { display: flex; align-items: center; gap: 12px; }
    .label { color: #444; font-weight: 600; min-width: 70px; display: inline-block; }
    .val { font-weight: 700; min-width: 80px; text-align: right; }
    #log { margin-top: 16px; height: 220px; overflow: auto; background: #0f172a; color: #e2e8f0; padding: 8px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .ts { color: #94a3b8; margin-right: 8px; }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
    .tx { color: #f59e0b; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">NodeFlow</div>
    <div class="actions">
      <button id="btn_pause">Pause</button>
      <button id="btn_resume">Resume</button>
      <button id="btn_step">Step</button>
      <button id="btn_reset">Reset</button>
      <select id="sel_clock">
        <option value="wall">Wall</option>
        <option value="virtual">Virtual</option>
      </select>
      <label>Rate Hz <input id="inp_rate" type="number" value="60" min="0" style="width:68px;"></label>
      <label>Scale <input id="inp_scale" type="number" value="1" min="0" step="0.1" style="width:60px;"></label>
      <span id="status" class="status">connecting…</span>
    </div>
  </div>

  <div class="row">
    <div class="ctrl">
      <span class="label">key1</span>
      <input type="checkbox" id="key1_cb">
      <span>send 1.0 when checked</span>
    </div>
    <div class="val" id="key1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl">
      <span class="label">key2</span>
      <input type="checkbox" id="key2_cb">
      <span>send 2.0 when checked</span>
    </div>
    <div class="val" id="key2_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl" style="width:360px;">
      <span class="label" style="min-width:70px;">random1</span>
      <input type="range" id="random1_slider" min="0" max="100" step="1" style="width:240px;">
      <span id="random1_send">0</span>
    </div>
    <div class="val" id="random1_val">-</div>
  </div>

  <div class="row">
    <div class="ctrl"><span class="label">metronome1</span><span>pulse (0/1)</span></div>
    <div class="val" id="metronome1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl"><span class="label">counter1</span><span>rising-edge count</span></div>
    <div class="val" id="counter1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl"><span class="label">add1 (core)</span></div>
    <div class="val" id="add1_val">-</div>
  </div>

  <div id="log"></div>

  <script>
    const statusEl = document.getElementById('status');
    const el = {
      key1_cb: document.getElementById('key1_cb'),
      key2_cb: document.getElementById('key2_cb'),
      random1_slider: document.getElementById('random1_slider'),
      random1_send: document.getElementById('random1_send'),
      key1_val: document.getElementById('key1_val'),
      key2_val: document.getElementById('key2_val'),
      random1_val: document.getElementById('random1_val'),
      metronome1_val: document.getElementById('metronome1_val'),
      counter1_val: document.getElementById('counter1_val'),
      add1_val: document.getElementById('add1_val'),
    };
    const logEl = document.getElementById('log');

    function ts() {
      const d = new Date();
      return d.toLocaleTimeString([], {hour12:false}) + '.' + String(d.getMilliseconds()).padStart(3,'0');
    }
    function log(s, cls) {
      const d = document.createElement('div');
      const t = document.createElement('span');
      t.className = 'ts'; t.textContent = '[' + ts() + ']';
      const m = document.createElement('span'); m.textContent = ' ' + s;
      d.appendChild(t); d.appendChild(m);
      if (cls) d.className = cls;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    }

    let ws;
    // dtype lookup built from schema: maps "nodeId:portId" and single-output aliases "nodeId" -> dtype
    const dtypeByKey = new Map();
    let nextTxId = 1;
    function connect() {
      statusEl.textContent = 'connecting…';
      const url = (location.protocol === 'https:' ? 'wss' : 'ws') + '://127.0.0.1:9002/stream';
      ws = new WebSocket(url);
      ws.onopen = () => { statusEl.textContent = 'connected'; log('connected','ok'); ws.send('{"type":"subscribe"}\n'); };
      ws.onclose = () => { statusEl.textContent = 'disconnected, retrying…'; log('disconnected','err'); setTimeout(connect, 1000); };
      ws.onerror = () => { log('error','err'); };
      ws.onmessage = (ev) => {
        const lines = String(ev.data).trim().split(/\n+/);
        for (const line of lines) {
          if (!line) continue;
          try {
            const msg = JSON.parse(line);
            if (msg.type === 'schema') {
              // Build dtype lookup for outputs and single-output node aliases
              dtypeByKey.clear();
              const outCount = new Map();
              if (Array.isArray(msg.ports)) {
                for (const p of msg.ports) {
                  if (p && p.direction === 'output') {
                    outCount.set(p.nodeId, (outCount.get(p.nodeId) || 0) + 1);
                  }
                }
                for (const p of msg.ports) {
                  if (p && p.direction === 'output') {
                    dtypeByKey.set(`${p.nodeId}:${p.portId}`, p.dtype);
                    if (outCount.get(p.nodeId) === 1) {
                      dtypeByKey.set(p.nodeId, p.dtype);
                    }
                  }
                }
              }
              log(line);
            } else if (msg.type === 'snapshot') {
              applyKV(msg);
            } else if (msg.type === 'delta') {
              log(line);
              applyKV(msg);
            } else if (Object.prototype.hasOwnProperty.call(msg, 'ok')) {
              log(`ok=${msg.ok}`, msg.ok ? 'ok' : 'err');
            }
          } catch { /* ignore non-JSON */ }
        }
      };
    }
    connect();

    function applyKV(obj) {
      const has = (k) => Object.prototype.hasOwnProperty.call(obj, k);
      const fmt = (key, num) => {
        const dtype = dtypeByKey.get(key);
        if (dtype === 'int') return String(Math.trunc(Number(num)));
        return Number(num).toFixed(3);
      };
      const render = (targetId, primaryKey, fallbackKey) => {
        let key = undefined;
        if (has(primaryKey)) key = primaryKey; else if (fallbackKey && has(fallbackKey)) key = fallbackKey;
        if (!key) return;
        const val = Number(obj[key]);
        if (!Number.isFinite(val)) return;
        document.getElementById(targetId).textContent = fmt(key, val);
      };
      // key1/key2/rand aliases
      render('key1_val', 'key1', 'key1:out1');
      render('key2_val', 'key2', 'key2:out1');
      render('random1_val', 'random1', 'random1:out1');
      // metronome (pulse 0/1)
      render('metronome1_val', 'metronome1', 'metronome1:out1');
      // counter
      render('counter1_val', 'counter1', 'counter1:out1');
      // add1 output
      render('add1_val', 'add1', 'add1:out1');
    }

    function sendJSON(obj) {
      if (!obj || typeof obj !== 'object') return;
      // assign tx_id if missing
      if (obj.tx_id === undefined) obj.tx_id = String(Date.now()) + '-' + String(nextTxId++);
      // derive short summary for TX log
      let summary = 'TX[' + (obj.type || 'unknown') + ']';
      if (obj.type === 'control') {
        summary += ' ' + (obj.cmd || '');
        if (obj.cmd === 'step_tick' && typeof obj.dt_ms === 'number') summary += ` dt=${obj.dt_ms}`;
        if (obj.cmd === 'set_rate' && typeof obj.hz === 'number') summary += ` hz=${obj.hz}`;
        if (obj.cmd === 'set_clock' && obj.clock) summary += ` clock=${obj.clock}`;
        if (obj.cmd === 'set_time_scale' && typeof obj.scale === 'number') summary += ` scale=${obj.scale}`;
      } else if (obj.type === 'set') {
        if (obj.node !== undefined && obj.value !== undefined) summary += ` ${obj.node}=${obj.value}`;
        else if (obj.handle !== undefined && obj.value !== undefined) summary += ` handle#${obj.handle}=${obj.value}`;
      }
      log(summary, 'tx');
      if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj) + '\n');
      else log('ws not ready','err');
    }

    // Toolbar controls → core control messages
    document.getElementById('btn_pause').addEventListener('click', () => sendJSON({ type: 'control', cmd: 'pause' }));
    document.getElementById('btn_resume').addEventListener('click', () => sendJSON({ type: 'control', cmd: 'resume' }));
    document.getElementById('btn_reset').addEventListener('click', () => sendJSON({ type: 'control', cmd: 'reset' }));
    document.getElementById('btn_step').addEventListener('click', () => sendJSON({ type: 'control', cmd: 'step_tick', dt_ms: 16.667 }));
    document.getElementById('sel_clock').addEventListener('change', () => sendJSON({ type: 'control', cmd: 'set_clock', clock: document.getElementById('sel_clock').value }));
    document.getElementById('inp_rate').addEventListener('change', () => sendJSON({ type: 'control', cmd: 'set_rate', hz: Number(document.getElementById('inp_rate').value) }));
    document.getElementById('inp_scale').addEventListener('change', () => sendJSON({ type: 'control', cmd: 'set_time_scale', scale: Number(document.getElementById('inp_scale').value) }));

    // Demo controls → core
    el.key1_cb.addEventListener('change', () => {
      const value = el.key1_cb.checked ? 1.0 : 0.0;
      sendJSON({ type: 'set', node: 'key1', value });
    });
    el.key2_cb.addEventListener('change', () => {
      const value = el.key2_cb.checked ? 2.0 : 0.0;
      sendJSON({ type: 'set', node: 'key2', value });
    });
    el.random1_slider.addEventListener('input', () => {
      el.random1_send.textContent = el.random1_slider.value;
    });
    el.random1_slider.addEventListener('change', () => {
      const value = Number(el.random1_slider.value);
      sendJSON({ type: 'set', node: 'random1', value });
    });
  </script>
</body>
</html>


