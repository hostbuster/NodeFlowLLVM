<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>NodeFlow Demo (Timer + Counter)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    h2 { margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 360px 200px; gap: 16px; align-items: center; margin: 8px 0; }
    .ctrl { display: flex; align-items: center; gap: 12px; }
    .label { color: #444; font-weight: 600; min-width: 70px; display: inline-block; }
    .val { font-weight: 700; min-width: 80px; text-align: right; }
    #log { margin-top: 16px; height: 220px; overflow: auto; background: #0f172a; color: #e2e8f0; padding: 8px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .ts { color: #94a3b8; margin-right: 8px; }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
  </style>
</head>
<body>
  <h2>NodeFlow Demo</h2>
  <div id="status">connecting…</div>

  <div class="row">
    <div class="ctrl">
      <span class="label">key1</span>
      <input type="checkbox" id="key1_cb">
      <span>send 1.0 when checked</span>
    </div>
    <div class="val" id="key1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl">
      <span class="label">key2</span>
      <input type="checkbox" id="key2_cb">
      <span>send 2.0 when checked</span>
    </div>
    <div class="val" id="key2_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl" style="width:360px;">
      <span class="label" style="min-width:70px;">random1</span>
      <input type="range" id="random1_slider" min="0" max="100" step="1" style="width:240px;">
      <span id="random1_send">0</span>
    </div>
    <div class="val" id="random1_val">-</div>
  </div>

  <div class="row">
    <div class="ctrl"><span class="label">metronome1</span><span>pulse (0/1)</span></div>
    <div class="val" id="metronome1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl"><span class="label">counter1</span><span>rising-edge count</span></div>
    <div class="val" id="counter1_val">-</div>
  </div>
  <div class="row">
    <div class="ctrl"><span class="label">add1 (core)</span></div>
    <div class="val" id="add1_val">-</div>
  </div>

  <div id="log"></div>

  <script>
    const statusEl = document.getElementById('status');
    const el = {
      key1_cb: document.getElementById('key1_cb'),
      key2_cb: document.getElementById('key2_cb'),
      random1_slider: document.getElementById('random1_slider'),
      random1_send: document.getElementById('random1_send'),
      key1_val: document.getElementById('key1_val'),
      key2_val: document.getElementById('key2_val'),
      random1_val: document.getElementById('random1_val'),
      metronome1_val: document.getElementById('metronome1_val'),
      counter1_val: document.getElementById('counter1_val'),
      add1_val: document.getElementById('add1_val'),
    };
    const logEl = document.getElementById('log');

    function ts() {
      const d = new Date();
      return d.toLocaleTimeString([], {hour12:false}) + '.' + String(d.getMilliseconds()).padStart(3,'0');
    }
    function log(s, cls) {
      const d = document.createElement('div');
      const t = document.createElement('span');
      t.className = 'ts'; t.textContent = '[' + ts() + ']';
      const m = document.createElement('span'); m.textContent = ' ' + s;
      d.appendChild(t); d.appendChild(m);
      if (cls) d.className = cls;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    }

    let ws;
    function connect() {
      statusEl.textContent = 'connecting…';
      const url = (location.protocol === 'https:' ? 'wss' : 'ws') + '://127.0.0.1:9002/stream';
      ws = new WebSocket(url);
      ws.onopen = () => { statusEl.textContent = 'connected'; log('connected','ok'); ws.send('{"type":"subscribe"}\n'); };
      ws.onclose = () => { statusEl.textContent = 'disconnected, retrying…'; log('disconnected','err'); setTimeout(connect, 1000); };
      ws.onerror = () => { log('error','err'); };
      ws.onmessage = (ev) => {
        const lines = String(ev.data).trim().split(/\n+/);
        for (const line of lines) {
          if (!line) continue;
          try {
            const msg = JSON.parse(line);
            if (msg.type === 'schema') {
              log(line);
            } else if (msg.type === 'snapshot') {
              applyKV(msg);
            } else if (msg.type === 'delta') {
              log(line);
              applyKV(msg);
            } else if (Object.prototype.hasOwnProperty.call(msg, 'ok')) {
              log(`ok=${msg.ok}`, msg.ok ? 'ok' : 'err');
            }
          } catch { /* ignore non-JSON */ }
        }
      };
    }
    connect();

    function applyKV(obj) {
      const v = (k) => (k in obj) ? Number(obj[k]) : undefined;
      const upd = (id, val) => { if (typeof val === 'number') document.getElementById(id).textContent = val.toFixed(3); };
      // key1/key2/rand aliases
      upd('key1_val', v('key1') ?? v('key1:out1'));
      upd('key2_val', v('key2') ?? v('key2:out1'));
      upd('random1_val', v('random1') ?? v('random1:out1'));
      // metronome (pulse 0/1)
      upd('metronome1_val', v('metronome1') ?? v('metronome1:out1'));
      // counter
      upd('counter1_val', v('counter1') ?? v('counter1:out1'));
      // add1 output
      upd('add1_val', v('add1') ?? v('add1:out1'));
    }

    function sendJSON(obj) {
      if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj) + '\n');
      else log('ws not ready','err');
    }

    // Controls → core
    el.key1_cb.addEventListener('change', () => {
      const value = el.key1_cb.checked ? 1.0 : 0.0;
      sendJSON({ type: 'set', node: 'key1', value });
      log(`set key1=${value}`);
    });
    el.key2_cb.addEventListener('change', () => {
      const value = el.key2_cb.checked ? 2.0 : 0.0;
      sendJSON({ type: 'set', node: 'key2', value });
      log(`set key2=${value}`);
    });
    el.random1_slider.addEventListener('input', () => {
      el.random1_send.textContent = el.random1_slider.value;
    });
    el.random1_slider.addEventListener('change', () => {
      const value = Number(el.random1_slider.value);
      sendJSON({ type: 'set', node: 'random1', value });
      log(`set random1=${value}`);
    });
  </script>
</body>
</html>


